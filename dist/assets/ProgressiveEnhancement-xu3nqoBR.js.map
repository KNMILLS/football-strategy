{"version":3,"file":"ProgressiveEnhancement-xu3nqoBR.js","sources":["../../src/ui/progressive/ProgressiveEnhancement.ts"],"sourcesContent":["import { EventBus } from '../../utils/EventBus';\r\n\r\n/**\r\n * Progressive enhancement utilities for better user experience\r\n * Handles feature detection, loading states, and graceful degradation\r\n */\r\n\r\n/**\r\n * Feature detection results\r\n */\r\nexport interface FeatureSupport {\r\n  webgl: boolean;\r\n  webAudio: boolean;\r\n  localStorage: boolean;\r\n  serviceWorker: boolean;\r\n  intersectionObserver: boolean;\r\n  requestIdleCallback: boolean;\r\n  webWorkers: boolean;\r\n}\r\n\r\n/**\r\n * Progressive enhancement configuration\r\n */\r\nexport interface ProgressiveConfig {\r\n  enableWebGL?: boolean;\r\n  enableWebAudio?: boolean;\r\n  enableOfflineSupport?: boolean;\r\n  enableAdvancedAnimations?: boolean;\r\n  enablePerformanceMonitoring?: boolean;\r\n}\r\n\r\n/**\r\n * Progressive enhancement manager\r\n */\r\nexport class ProgressiveEnhancement {\r\n  private features: FeatureSupport;\r\n  private config: ProgressiveConfig;\r\n  private bus: EventBus;\r\n\r\n  constructor(bus: EventBus, config: ProgressiveConfig = {}) {\r\n    this.bus = bus;\r\n    this.config = {\r\n      enableWebGL: config.enableWebGL ?? this.detectWebGL(),\r\n      enableWebAudio: config.enableWebAudio ?? this.detectWebAudio(),\r\n      enableOfflineSupport: config.enableOfflineSupport ?? this.detectServiceWorker(),\r\n      enableAdvancedAnimations: config.enableAdvancedAnimations ?? this.detectAdvancedAnimations(),\r\n      enablePerformanceMonitoring: config.enablePerformanceMonitoring ?? true\r\n    };\r\n\r\n    this.features = this.detectFeatures();\r\n    this.initializeProgressiveFeatures();\r\n  }\r\n\r\n  /**\r\n   * Detects browser feature support\r\n   */\r\n  private detectFeatures(): FeatureSupport {\r\n    return {\r\n      webgl: this.detectWebGL(),\r\n      webAudio: this.detectWebAudio(),\r\n      localStorage: this.detectLocalStorage(),\r\n      serviceWorker: this.detectServiceWorker(),\r\n      intersectionObserver: this.detectIntersectionObserver(),\r\n      requestIdleCallback: this.detectRequestIdleCallback(),\r\n      webWorkers: this.detectWebWorkers()\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Detects WebGL support\r\n   */\r\n  private detectWebGL(): boolean {\r\n    try {\r\n      const canvas = document.createElement('canvas');\r\n      return !!(window.WebGLRenderingContext &&\r\n                (canvas.getContext('webgl') || canvas.getContext('experimental-webgl')));\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Detects Web Audio API support\r\n   */\r\n  private detectWebAudio(): boolean {\r\n    return 'webkitAudioContext' in window || 'AudioContext' in window;\r\n  }\r\n\r\n  /**\r\n   * Detects LocalStorage support\r\n   */\r\n  private detectLocalStorage(): boolean {\r\n    try {\r\n      const test = '__localStorage_test__';\r\n      localStorage.setItem(test, test);\r\n      localStorage.removeItem(test);\r\n      return true;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Detects Service Worker support\r\n   */\r\n  private detectServiceWorker(): boolean {\r\n    return 'serviceWorker' in navigator;\r\n  }\r\n\r\n  /**\r\n   * Detects Intersection Observer support\r\n   */\r\n  private detectIntersectionObserver(): boolean {\r\n    return 'IntersectionObserver' in window;\r\n  }\r\n\r\n  /**\r\n   * Detects requestIdleCallback support\r\n   */\r\n  private detectRequestIdleCallback(): boolean {\r\n    return 'requestIdleCallback' in window;\r\n  }\r\n\r\n  /**\r\n   * Detects Web Workers support\r\n   */\r\n  private detectWebWorkers(): boolean {\r\n    return 'Worker' in window;\r\n  }\r\n\r\n  /**\r\n   * Detects advanced animation capabilities\r\n   */\r\n  private detectAdvancedAnimations(): boolean {\r\n    // Check for CSS transforms, transitions, and animations\r\n    const style = document.createElement('div').style;\r\n    return 'transform' in style &&\r\n           'transition' in style &&\r\n           'animation' in style &&\r\n           this.detectWebGL(); // Require WebGL for advanced animations\r\n  }\r\n\r\n  /**\r\n   * Initializes progressive features based on detected support\r\n   */\r\n  private initializeProgressiveFeatures(): void {\r\n    // Emit feature detection results\r\n    (this.bus as any).emit('features:detected', { features: this.features });\r\n\r\n    // Enable features based on support and configuration\r\n    if (this.config.enableWebGL && this.features.webgl) {\r\n      this.enableWebGLFeatures();\r\n    }\r\n\r\n    if (this.config.enableWebAudio && this.features.webAudio) {\r\n      this.enableWebAudioFeatures();\r\n    }\r\n\r\n    if (this.config.enableOfflineSupport && this.features.serviceWorker) {\r\n      this.enableOfflineSupport();\r\n    }\r\n\r\n    if (this.config.enableAdvancedAnimations && this.features.intersectionObserver) {\r\n      this.enableAdvancedAnimations();\r\n    }\r\n\r\n    if (this.config.enablePerformanceMonitoring) {\r\n      this.enablePerformanceMonitoring();\r\n    }\r\n\r\n    // Set up lazy loading for images\r\n    if (this.features.intersectionObserver) {\r\n      this.setupLazyLoading();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Enables WebGL features if supported\r\n   */\r\n  private enableWebGLFeatures(): void {\r\n    (this.bus as any).emit('webgl:enabled', {});\r\n\r\n    // Add WebGL-specific CSS classes\r\n    document.body.classList.add('webgl-supported');\r\n\r\n    // Emit event for field component to use WebGL rendering\r\n    (this.bus as any).emit('ui:enhancement', {\r\n      type: 'webgl',\r\n      enabled: true,\r\n      message: 'Enhanced graphics enabled'\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Enables Web Audio features if supported\r\n   */\r\n  private enableWebAudioFeatures(): void {\r\n    (this.bus as any).emit('webaudio:enabled', {});\r\n\r\n    // Add Web Audio-specific CSS classes\r\n    document.body.classList.add('webaudio-supported');\r\n\r\n    // Emit event for SFX component to use Web Audio\r\n    (this.bus as any).emit('ui:enhancement', {\r\n      type: 'webaudio',\r\n      enabled: true,\r\n      message: 'Enhanced audio enabled'\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Enables offline support if service workers are supported\r\n   */\r\n  private enableOfflineSupport(): void {\r\n    (this.bus as any).emit('offline:enabled', {});\r\n\r\n    // Register service worker for offline functionality\r\n    // Only attempt registration in production builds where sw.js is served with the correct MIME type\r\n    try {\r\n      const isProd = typeof import.meta !== 'undefined' && (import.meta as any).env && (import.meta as any).env.PROD;\r\n      if ('serviceWorker' in navigator && isProd) {\r\n        // Optionally verify sw.js is reachable before registering\r\n        fetch('/sw.js', { method: 'HEAD' }).then(resp => {\r\n          if (!resp.ok) throw new Error(`sw.js not found (${resp.status})`);\r\n          return navigator.serviceWorker.register('/sw.js');\r\n        }).then(registration => {\r\n          (this.bus as any).emit('offline:ready', { registration });\r\n        }).catch(error => {\r\n          console.warn('Service worker registration failed:', error);\r\n        });\r\n      }\r\n    } catch (error) {\r\n      console.warn('Service worker registration skipped:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Enables advanced animations if supported\r\n   */\r\n  private enableAdvancedAnimations(): void {\r\n    (this.bus as any).emit('animations:enabled', {});\r\n\r\n    // Add animation-specific CSS classes\r\n    document.body.classList.add('animations-supported');\r\n\r\n    // Emit event for VFX component to use advanced animations\r\n    (this.bus as any).emit('ui:enhancement', {\r\n      type: 'animations',\r\n      enabled: true,\r\n      message: 'Enhanced animations enabled'\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Enables performance monitoring\r\n   */\r\n  private enablePerformanceMonitoring(): void {\r\n    if ('performance' in window && 'measure' in performance) {\r\n      this.setupPerformanceMonitoring();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Sets up performance monitoring\r\n   */\r\n  private setupPerformanceMonitoring(): void {\r\n    let startTime = performance.now();\r\n\r\n    // Monitor frame rate\r\n    let frameCount = 0;\r\n    let lastFrameTime = performance.now();\r\n\r\n    const measureFrameRate = () => {\r\n      frameCount++;\r\n      const now = performance.now();\r\n      const elapsed = now - lastFrameTime;\r\n\r\n      if (elapsed >= 1000) { // Every second\r\n        const fps = Math.round((frameCount * 1000) / elapsed);\r\n        (this.bus as any).emit('performance:fps', { fps });\r\n\r\n        frameCount = 0;\r\n        lastFrameTime = now;\r\n      }\r\n\r\n      requestAnimationFrame(measureFrameRate);\r\n    };\r\n\r\n    requestAnimationFrame(measureFrameRate);\r\n\r\n    // Monitor UI registration time\r\n    (this.bus as any).on('ui:ready', () => {\r\n      const loadTime = performance.now() - startTime;\r\n      performance.mark('ui-ready');\r\n\r\n      (this.bus as any).emit('performance:loadTime', {\r\n        loadTime,\r\n        mark: 'ui-ready'\r\n      });\r\n    });\r\n\r\n    // Monitor game flow events\r\n    (this.bus as any).on('flow:gameStart', () => {\r\n      performance.mark('game-start');\r\n      const gameStartTime = performance.now() - startTime;\r\n\r\n      (this.bus as any).emit('performance:gameStartTime', {\r\n        gameStartTime,\r\n        mark: 'game-start'\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Sets up lazy loading for images\r\n   */\r\n  private setupLazyLoading(): void {\r\n    const lazyImages = document.querySelectorAll('img[data-src]');\r\n\r\n    if (lazyImages.length === 0) return;\r\n\r\n    const imageObserver = new IntersectionObserver((entries, observer) => {\r\n      entries.forEach(entry => {\r\n        if (entry.isIntersecting) {\r\n          const img = entry.target as HTMLImageElement;\r\n          img.src = img.dataset.src!;\r\n          img.classList.remove('lazy');\r\n          observer.unobserve(img);\r\n        }\r\n      });\r\n    });\r\n\r\n    lazyImages.forEach(img => imageObserver.observe(img));\r\n  }\r\n\r\n  /**\r\n   * Gets current feature support status\r\n   */\r\n  getFeatures(): FeatureSupport {\r\n    return { ...this.features };\r\n  }\r\n\r\n  /**\r\n   * Gets current configuration\r\n   */\r\n  getConfig(): ProgressiveConfig {\r\n    return { ...this.config };\r\n  }\r\n\r\n  /**\r\n   * Checks if a specific feature is supported and enabled\r\n   */\r\n  isFeatureEnabled(feature: keyof FeatureSupport): boolean {\r\n    return this.features[feature] && this.config[`enable${feature.charAt(0).toUpperCase() + feature.slice(1)}` as keyof ProgressiveConfig] === true;\r\n  }\r\n\r\n  /**\r\n   * Enables a specific feature if supported\r\n   */\r\n  enableFeature(feature: keyof FeatureSupport): boolean {\r\n    if (!this.features[feature]) {\r\n      return false;\r\n    }\r\n\r\n    const configKey = `enable${feature.charAt(0).toUpperCase() + feature.slice(1)}` as keyof ProgressiveConfig;\r\n    this.config[configKey] = true;\r\n\r\n    // Trigger feature-specific initialization\r\n    switch (feature) {\r\n      case 'webgl':\r\n        this.enableWebGLFeatures();\r\n        break;\r\n      case 'webAudio':\r\n        this.enableWebAudioFeatures();\r\n        break;\r\n      case 'serviceWorker':\r\n        this.enableOfflineSupport();\r\n        break;\r\n      case 'intersectionObserver':\r\n        this.enableAdvancedAnimations();\r\n        break;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Disables a specific feature\r\n   */\r\n  disableFeature(feature: keyof FeatureSupport): void {\r\n    const configKey = `enable${feature.charAt(0).toUpperCase() + feature.slice(1)}` as keyof ProgressiveConfig;\r\n    this.config[configKey] = false;\r\n\r\n    // Remove feature-specific CSS classes\r\n    switch (feature) {\r\n      case 'webgl':\r\n        document.body.classList.remove('webgl-supported');\r\n        break;\r\n      case 'webAudio':\r\n        document.body.classList.remove('webaudio-supported');\r\n        break;\r\n      case 'intersectionObserver':\r\n        document.body.classList.remove('animations-supported');\r\n        break;\r\n    }\r\n  }\r\n}\r\n"],"names":["ProgressiveEnhancement","bus","config","canvas","test","style","isProd","__vite_import_meta_env__","resp","registration","error","startTime","frameCount","lastFrameTime","measureFrameRate","now","elapsed","fps","loadTime","gameStartTime","lazyImages","imageObserver","entries","observer","entry","img","feature","configKey"],"mappings":"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"}